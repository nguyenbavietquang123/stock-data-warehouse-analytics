# -*- coding: utf-8 -*-
"""DataVisualization.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/16UDGI-aY6xdykKk-KbxV2ZFfQPAcXtaH

**Read data**
"""

import pandas as pd
import os
import glob
from google.colab import drive
# 1. K·∫øt n·ªëi Google Drive
drive.mount('/content/drive', force_remount=True)
# ----------------------------------------------------
data_folder_path = '/content/drive/My Drive/cleaned/'
# Kh·ªüi t·∫°o m·ªôt dictionary r·ªóng ƒë·ªÉ ch·ª©a d·ªØ li·ªáu
stock_data = {}

# T·ª± ƒë·ªông t√¨m t·∫•t c·∫£ c√°c file .csv trong th∆∞ m·ª•c
all_csv_files = glob.glob(os.path.join(data_folder_path, "*.csv"))

if not all_csv_files:
    print(f"L·ªñI: Kh√¥ng t√¨m th·∫•y file .csv n√†o trong: {data_folder_path}")
else:
    print(f"T√¨m th·∫•y {len(all_csv_files)} file. B·∫Øt ƒë·∫ßu ƒë·ªçc...")

    for file_path in all_csv_files:
        try:
            # L·∫•y t√™n file (v√≠ d·ª•: 'HVN.csv') t·ª´ ƒë∆∞·ªùng d·∫´n
            file_name = os.path.basename(file_path)
            # L·∫•y ticker (v√≠ d·ª•: 'HVN') t·ª´ t√™n file (b·ªè ƒëu√¥i .csv)
            ticker = os.path.splitext(file_name)[0]

            if ticker == "All":
              continue

            # ƒê·ªçc file CSV
            df = pd.read_csv(file_path, parse_dates=['Date'], index_col='Date')

            # L∆∞u DataFrame v√†o dictionary v·ªõi key l√† ticker
            stock_data[ticker] = df

            print(f"  ƒê√£ ƒë·ªçc {file_name:10} -> l∆∞u v√†o stock_data['{ticker}']")

        except Exception as e:
            print(f"L·ªói khi ƒë·ªçc file {file_path}: {e}")

# --- H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng ---
print("\n================================================")
print("ƒê·ªåC D·ªÆ LI·ªÜU V√ÄO DICTIONARY TH√ÄNH C√îNG!")
print("================================================\n")
print("ƒê·ªÉ xem 5 d√≤ng ƒë·∫ßu c·ªßa m√£ HVN, b·∫°n d√πng:")
print("stock_data['HVN'].head()")

# B·ªè b√¨nh lu·∫≠n (uncomment) d√≤ng d∆∞·ªõi ƒë·ªÉ ch·∫°y th·ª≠:
if 'HVN' in stock_data:
    print(stock_data['HVN'].head())
else:
    print("\nKh√¥ng t√¨m th·∫•y ticker 'HVN' trong d·ªØ li·ªáu, h√£y ki·ªÉm tra l·∫°i t√™n file.")

# G·ªôp t·∫•t c·∫£ c√°c DataFrame trong dictionary l·∫°i th√†nh 1 DataFrame duy nh·∫•t
try:
    combined_df = pd.concat(stock_data.values())

    # S·∫Øp x·∫øp l·∫°i to√†n b·ªô DataFrame theo ng√†y (index)
    combined_df.sort_index(inplace=True)

    print("ƒê√£ t·∫°o combined_df th√†nh c√¥ng!")
    print(combined_df.head())
    print(combined_df['Ticker'].unique())
except Exception as e:
    print(f"L·ªói khi g·ªôp dictionary: {e}")

# C√†i ƒë·∫∑t th∆∞ vi·ªán (n·∫øu c·∫ßn)
# !pip install plotly seaborn
# !pip install -U kaleido


import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots

# C√†i ƒë·∫∑t theme m·∫∑c ƒë·ªãnh cho seaborn
sns.set_theme(style="whitegrid")

# Gi·∫£ s·ª≠ c√°c m√£ c·ªï phi·∫øu c·ªßa b·∫°n l√†:
tickers = sorted(combined_df['Ticker'].unique())

# Ch·ªçn b·∫£ng m√†u Set2
palette = px.colors.qualitative.Set2

# T·∫°o map gi·ªØa Ticker v√† m√†u
color_map = {ticker: palette[i % len(palette)] for i, ticker in enumerate(tickers)}

from google.colab import files

import plotly.express as px
import plotly.io as pio

print(pio.kaleido.scope)

print("--- 1. B·∫Øt ƒë·∫ßu v·∫Ω Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng (Gi√° ƒë√≥ng c·ª≠a) cho 7 m√£ ---")

# Gi·∫£ s·ª≠ 'stock_data' l√† dictionary ch·ª©a { 'M√É': DataFrame }
# Trong ƒë√≥ m·ªói DataFrame c√≥ c·ªôt 'Close' v√† index l√† ng√†y (DatetimeIndex)

for ticker, df in stock_data.items():

    # D√πng plotly.express ƒë·ªÉ v·∫Ω
    fig = px.line(
        df,
        x=df.index,
        y='Close',
        # title=f"Bi·ªÉu ƒë·ªì gi√° ƒë√≥ng c·ª≠a c·ªßa m√£ {ticker}",
        labels={
            "index": "Ng√†y giao d·ªãch",
            "Close": "Gi√° ƒë√≥ng c·ª≠a (VND)"
        }
    )

    # C·∫≠p nh·∫≠t b·ªë c·ª•c (layout)
    fig.update_layout(
        title={
            # 'text': f"üìà Bi·ªÉu ƒë·ªì gi√° ƒë√≥ng c·ª≠a c·ªßa m√£ {ticker}",
            'y':0.97,
            'x':0.5,
            'xanchor': 'center',
            'yanchor': 'top'
        },
        font=dict(family="Arial", size=14),
        xaxis_title="Ng√†y giao d·ªãch",
        yaxis_title="Gi√° ƒë√≥ng c·ª≠a (VND)",  # c√≥ th·ªÉ ƒë·ªïi sang USD n·∫øu c·∫ßn
        legend_title_text="Ch√∫ th√≠ch",
        plot_bgcolor="white"
    )

    # C·∫≠p nh·∫≠t m√†u v√† ƒë∆∞·ªùng k·∫ª
    fig.update_yaxes(
        tickformat=",.0f",          # Hi·ªÉn th·ªã 120000 ‚Üí 120,000
        showgrid=True,
        gridwidth=0.5,
        gridcolor="LightGray"
    )

    fig.update_xaxes(
        title_text="Ng√†y",
        tickformat="%Y-%m",        # hi·ªÉn th·ªã 2024-04 thay v√¨ Apr 2024
        showgrid=True,
        gridwidth=0.5,
        gridcolor="LightGray"
    )
    # Hi·ªÉn th·ªã bi·ªÉu ƒë·ªì
    fig.show()

    # Xu·∫•t file ·∫£nh PNG
    filename = f"{ticker}_close_chart.png"
    fig.write_image(filename, scale = 3)
    files.download(filename)
    print(f"‚úÖ ƒê√£ l∆∞u: {filename}")

print("--- üéâ Ho√†n th√†nh 7 bi·ªÉu ƒë·ªì ƒë∆∞·ªùng ---")

print("\n--- 2. B·∫Øt ƒë·∫ßu v·∫Ω Bi·ªÉu ƒë·ªì c·ªôt (So s√°nh Kh·ªëi l∆∞·ª£ng TB) ---")

# 1. T·∫°o m·ªôt dictionary ƒë·ªÉ l∆∞u kh·ªëi l∆∞·ª£ng trung b√¨nh
average_volumes = {}

# L·∫∑p qua c√°c m√£ ƒë·ªÉ t√≠nh gi√° tr·ªã trung b√¨nh
for ticker, df in stock_data.items():
    average_volumes[ticker] = df['Volume'].mean()

# 2. Chuy·ªÉn dictionary v·ª´a t·∫°o th√†nh DataFrame ƒë·ªÉ v·∫Ω
avg_vol_df = pd.DataFrame(average_volumes.items(),
                          columns=['Ticker', 'AverageVolume'])

# 3. S·∫Øp x·∫øp ƒë·ªÉ bi·ªÉu ƒë·ªì d·ªÖ nh√¨n h∆°n (t√πy ch·ªçn)
avg_vol_df = avg_vol_df.sort_values(by='AverageVolume', ascending=False)

# 4. V·∫Ω bi·ªÉu ƒë·ªì c·ªôt b·∫±ng Plotly
fig_bar = px.bar(
    avg_vol_df,
    x='Ticker',
    y='AverageVolume',
    color='Ticker',  # th√™m m√†u kh√°c nhau cho t·ª´ng m√£
    # color_discrete_sequence=px.colors.qualitative.Set2,  # b·ªô m√†u nh·∫π
    color_discrete_map=color_map
)

fig_bar.update_traces(
    texttemplate='%{y:,.0f}',
    textposition='outside'
)

fig_bar.update_layout(
    title={
        # 'text': "So s√°nh Kh·ªëi l∆∞·ª£ng Giao d·ªãch Trung b√¨nh c√°c M√£ C·ªï phi·∫øu",
        'y': 0.92,
        'x': 0.5,
        'xanchor': 'center',
        'yanchor': 'top',
        'font': dict(size=20, family='Arial', color='black')
    },
    xaxis_title='M√£ C·ªï phi·∫øu',
    yaxis_title='Kh·ªëi l∆∞·ª£ng trung b√¨nh (c·ªï phi·∫øu)',
    font=dict(family="Arial", size=14, color="black"),
    plot_bgcolor='white',
    paper_bgcolor='white',
)
fig_bar.show()

fig_bar.update_xaxes(
    mirror=True,
    showgrid=True,
    gridwidth=1,
    gridcolor='lightgray'
)
fig_bar.update_yaxes(
    mirror=True,
    showgrid=True,
    gridwidth=1,
    gridcolor='lightgray'
)

filename123 = f"AverageVolumn.png"
fig_bar.write_image(filename123)
files.download(filename123)

print("--- Ho√†n th√†nh 1 bi·ªÉu ƒë·ªì c·ªôt so s√°nh ---")

print("\n--- 3. B·∫Øt ƒë·∫ßu v·∫Ω Bi·ªÉu ƒë·ªì nhi·ªát (Heatmap) cho 7 m√£ ---")

# C√°c c·ªôt b·∫°n mu·ªën ph√¢n t√≠ch t∆∞∆°ng quan
columns_to_correlate = ['Open', 'High', 'Low', 'Close', 'Volume']

for ticker, df in stock_data.items():

    # 1. L·ªçc ra DataFrame con ch·ªâ ch·ª©a 5 c·ªôt c·∫ßn thi·∫øt
    df_subset = df[columns_to_correlate]

    # 2. T√≠nh ma tr·∫≠n t∆∞∆°ng quan
    corr_matrix = df_subset.corr()

    # 3. V·∫Ω Heatmap b·∫±ng Seaborn
    # (plt.figure) t·∫°o m·ªôt khung h√¨nh m·ªõi cho m·ªói bi·ªÉu ƒë·ªì
    plt.figure(figsize=(8, 6))

    sns.heatmap(corr_matrix,
                annot=True,     # Hi·ªÉn th·ªã s·ªë (gi√° tr·ªã t∆∞∆°ng quan)
                cmap='coolwarm',# D√πng thang m√†u Xanh-ƒê·ªè
                fmt='.2f',      # ƒê·ªãnh d·∫°ng s·ªë (2 ch·ªØ s·ªë th·∫≠p ph√¢n)
                linewidths=.5)

    plt.title(f'Ma tr·∫≠n t∆∞∆°ng quan (O-H-L-C-Vol) c·ªßa m√£: {ticker}')

    # (plt.show) hi·ªÉn th·ªã bi·ªÉu ƒë·ªì v·ª´a v·∫Ω
    plt.show()

print("--- Ho√†n th√†nh 7 bi·ªÉu ƒë·ªì nhi·ªát ---")

import numpy as np
import plotly.express as px
from google.colab import files

print("--- 1. B·∫Øt ƒë·∫ßu v·∫Ω Bi·ªÉu ƒë·ªì L·ª£i nhu·∫≠n T√≠ch l≈©y ---")

# 1. T√≠nh l·ª£i nhu·∫≠n t√≠ch l≈©y cho m·ªói m√£
df_cum = combined_df.reset_index()

# T√≠nh LogReturn t√≠ch l≈©y
df_cum['CumulativeLogReturn'] = df_cum.groupby('Ticker')['LogReturn'].cumsum()

# 2. ƒê·ªïi Log Return ‚Üí Return t√≠ch l≈©y (gi√° tr·ªã n·∫øu ƒë·∫ßu t∆∞ 1ƒë ban ƒë·∫ßu)
df_cum['CumulativeReturn'] = df_cum.groupby('Ticker')['CumulativeLogReturn'].transform(lambda x: np.exp(x))

fig_cum_return = px.line(
    df_cum,
    x='Date',
    y='CumulativeReturn',
    color='Ticker',  # Ph√¢n bi·ªát c√°c m√£ b·∫±ng m√†u s·∫Øc
    # color_discrete_sequence=px.colors.qualitative.Set2  # Gi·ªØ m√†u gi·ªëng bi·ªÉu ƒë·ªì bar
    color_discrete_map=color_map
)

fig_cum_return.update_layout(
    yaxis_title='H·ªá s·ªë tƒÉng tr∆∞·ªüng',
    xaxis_title='Ng√†y',
    legend_title='M√£ C·ªï phi·∫øu',
    plot_bgcolor='white',   # N·ªÅn v√πng bi·ªÉu ƒë·ªì tr·∫Øng
    paper_bgcolor='white'
)

# 5. ƒê·ªãnh d·∫°ng tr·ª•c & l∆∞·ªõi (gi·ªëng bi·ªÉu ƒë·ªì Close)
fig_cum_return.update_xaxes(
    tickformat="%Y-%m",       # üìÖ ƒë·ªãnh d·∫°ng 2024-04
    # showline=True,
    # linewidth=2,
    # linecolor='black',
    mirror=True,
    showgrid=True,
    gridwidth=1,
    gridcolor='lightgray'
)
fig_cum_return.update_yaxes(
    tickformat=",.2f",        # üí∞ hi·ªÉn th·ªã 1.25 ‚Üí 1.25; 10.00 ‚Üí 10.00
    # showline=True,
    # linewidth=2,
    # linecolor='black',
    mirror=True,
    showgrid=True,
    gridwidth=1,
    gridcolor='lightgray'
)

# 6. Hi·ªÉn th·ªã
fig_cum_return.show()

# 7. Xu·∫•t file ·∫£nh
filename1234 = "CumulativeLogReturn.png"
fig_cum_return.write_image(filename1234)
files.download(filename1234)

print("--- Ho√†n th√†nh Bi·ªÉu ƒë·ªì L·ª£i nhu·∫≠n T√≠ch l≈©y ---")

# import numpy as np

# print("--- 1. B·∫Øt ƒë·∫ßu v·∫Ω Bi·ªÉu ƒë·ªì L·ª£i nhu·∫≠n T√≠ch l≈©y ---")

# # 1. T√≠nh l·ª£i nhu·∫≠n t√≠ch l≈©y cho m·ªói m√£
# # D√πng LogReturn ƒë·ªÉ c·ªông d·ªìn (cumsum)
# # (Ch√∫ng ta c·∫ßn reset_index ƒë·ªÉ Ticker v√† Date tr·ªü th√†nh c·ªôt)
# df_cum = combined_df.reset_index()

# # T√≠nh LogReturn t√≠ch l≈©y
# df_cum['CumulativeLogReturn'] = df_cum.groupby('Ticker')['LogReturn'].cumsum()

# # 2. Chuy·ªÉn ƒë·ªïi t·ª´ Log Return t√≠ch l≈©y v·ªÅ Return t√≠ch l≈©y
# # (1 ƒë·ªìng ƒë·∫ßu t∆∞ ban ƒë·∫ßu s·∫Ω th√†nh bao nhi√™u ƒë·ªìng)
# df_cum['CumulativeReturn'] = (
#     df_cum.groupby('Ticker')['CumulativeLogReturn']
#     .transform(lambda x: np.exp(x))
# )

# # 3. V·∫Ω b·∫±ng Plotly
# fig_cum_return = px.line(df_cum,
#                          x='Date',
#                          y='CumulativeReturn',
#                          color='Ticker', # Ph√¢n bi·ªát c√°c m√£ b·∫±ng m√†u s·∫Øc
#                         #  title='So s√°nh Hi·ªáu su·∫•t ƒê·∫ßu t∆∞ (L·ª£i nhu·∫≠n T√≠ch l≈©y)'
#                          )
# fig_cum_return.update_layout(yaxis_title='Gi√° tr·ªã (n·∫øu ƒë·∫ßu t∆∞ 1ƒë ban ƒë·∫ßu)',
#                            xaxis_title='Ng√†y',
#                            legend_title='M√£ C·ªï phi·∫øu')
# fig_cum_return.show()

# filename1234 = f"CumulativeLogReturn.png"
# fig_cum_return.write_image(filename1234)
# # files.download(filename1234)

# print("--- Ho√†n th√†nh Bi·ªÉu ƒë·ªì L·ª£i nhu·∫≠n T√≠ch l≈©y ---")

"""M·ª•c ƒë√≠ch: ƒê√¢y l√† bi·ªÉu ƒë·ªì quan tr·ªçng nh·∫•t ƒë·ªÉ so s√°nh hi·ªáu su·∫•t ƒë·∫ßu t∆∞.

√ù nghƒ©a: N√≥ tr·∫£ l·ªùi c√¢u h·ªèi: "N·∫øu b·∫°n ƒë·∫ßu t∆∞ 1 ƒë·ªìng v√†o m·ªói m√£ (HVN, VJC, ...) v√†o ng√†y ƒë·∫ßu ti√™n (01/2024), th√¨ ƒë·∫øn h√¥m nay, m√£ n√†o mang l·∫°i l·ª£i nhu·∫≠n cao nh·∫•t?"
"""

print("--- 2. B·∫Øt ƒë·∫ßu v·∫Ω Bi·ªÉu ƒë·ªì H·ªôp (So s√°nh R·ªßi ro) ---")

# ƒê·∫∑t k√≠ch th∆∞·ªõc cho bi·ªÉu ƒë·ªì
plt.figure(figsize=(12, 7))

# S·ª≠ d·ª•ng seaborn ƒë·ªÉ v·∫Ω boxplot
sns.boxplot(data=combined_df,
            x='Ticker',
            y='LogReturn') # D√πng LogReturn ƒë·ªÉ so s√°nh

# ƒê·∫∑t ti√™u ƒë·ªÅ v√† nh√£n tr·ª•c
# plt.title('So s√°nh Ph√¢n ph·ªëi L·ª£i nhu·∫≠n (R·ªßi ro) gi·ªØa c√°c M√£', fontsize=16)
plt.xlabel('M√£ C·ªï phi·∫øu')
plt.ylabel('L·ª£i nhu·∫≠n Logarit (LogReturn)')
plt.axhline(0, color='red', linestyle='--', label='H√≤a v·ªën (0)') # Th√™m ƒë∆∞·ªùng 0
plt.legend()
output_path = "boxplot_rui_ro.png"
plt.savefig(output_path, bbox_inches='tight', dpi=300)
plt.show()

files.download(output_path)

print("--- Ho√†n th√†nh Bi·ªÉu ƒë·ªì H·ªôp ---")

"""M·ª•c ƒë√≠ch: So s√°nh tr·ª±c quan ƒë·ªô bi·∫øn ƒë·ªông (r·ªßi ro) c·ªßa c√°c m√£.

√ù nghƒ©a: Bi·ªÉu ƒë·ªì n√†y cho th·∫•y ph√¢n ph·ªëi l·ª£i nhu·∫≠n h√†ng ng√†y.

H·ªôp (box) c√†ng d√†i: M√£ ƒë√≥ c√†ng bi·∫øn ƒë·ªông, r·ªßi ro c√†ng cao.

C√°c d·∫•u ch·∫•m (outliers): L√† nh·ªØng ng√†y c√≥ bi·∫øn ƒë·ªông c·ª±c l·ªõn (l√£i s·ªëc ho·∫∑c l·ªó s·ªëc).

ƒê∆∞·ªùng ngang ·ªü gi·ªØa: L·ª£i nhu·∫≠n trung v·ªã (median).
"""

print("--- 4. B·∫Øt ƒë·∫ßu v·∫Ω Bi·ªÉu ƒë·ªì Bi·∫øn ƒë·ªông Tr∆∞·ª£t ---")

# 1. T√≠nh to√°n ƒë·ªô l·ªách chu·∫©n tr∆∞·ª£t (v√≠ d·ª• c·ª≠a s·ªï 20 ng√†y)
rolling_vol = (
    combined_df.groupby('Ticker')['LogReturn']
    .rolling(window=20)   # C·ª≠a s·ªï tr∆∞·ª£t 20 ng√†y
    .std()                # T√≠nh ƒë·ªô l·ªách chu·∫©n
    .reset_index()
    .rename(columns={'LogReturn':'RollingVolatility'})
)

# 2. V·∫Ω b·∫±ng Plotly
fig_rolling_vol = px.line(
    rolling_vol,
    x='Date',
    y='RollingVolatility',
    color='Ticker',
    # color_discrete_sequence=px.colors.qualitative.Set2  # Gi·ªØ m√†u ƒë·ªìng b·ªô
    color_discrete_map=color_map
)

# 3. T√πy ch·ªânh layout
fig_rolling_vol.update_layout(
    plot_bgcolor='white',
    paper_bgcolor='white',
    yaxis_title='ƒê·ªô l·ªách chu·∫©n',
    xaxis_title='Ng√†y',
    legend_title='M√£ C·ªï phi·∫øu',
    font=dict(size=13),
    margin=dict(l=60, r=30, t=40, b=50)
)

# 4. ƒê·ªãnh d·∫°ng tr·ª•c
fig_rolling_vol.update_xaxes(
    tickformat="%Y-%m",  # hi·ªÉn th·ªã theo d·∫°ng 2024-04
    showgrid=True, gridwidth=0.5, gridcolor="LightGray"
)
fig_rolling_vol.update_yaxes(
    tickformat=".2f",    # hi·ªÉn th·ªã 0.0123 thay v√¨ 0.0123456
    showgrid=True, gridwidth=0.5, gridcolor="LightGray"
)

fig_rolling_vol.show()

filename1234a = "RollingVolatility20.png"
fig_rolling_vol.write_image(filename1234a)
files.download(filename1234a)

print("--- Ho√†n th√†nh Bi·ªÉu ƒë·ªì Bi·∫øn ƒë·ªông Tr∆∞·ª£t ---")

# print("--- 4. B·∫Øt ƒë·∫ßu v·∫Ω Bi·ªÉu ƒë·ªì Bi·∫øn ƒë·ªông Tr∆∞·ª£t ---")

# # 1. T√≠nh to√°n ƒë·ªô l·ªách chu·∫©n tr∆∞·ª£t (v√≠ d·ª• c·ª≠a s·ªï 30 ng√†y)
# # D√πng groupby('Ticker') ƒë·ªÉ t√≠nh rolling cho t·ª´ng m√£
# rolling_vol = (
#     combined_df.groupby('Ticker')['LogReturn']
#     .rolling(window=20)   # C·ª≠a s·ªï tr∆∞·ª£t 30 ng√†y
#     .std()                # T√≠nh ƒë·ªô l·ªách chu·∫©n
#     .reset_index()
#     .rename(columns={'LogReturn':'RollingVolatility'})
# )
# # (Ch√∫ng ta c·∫ßn nh√¢n v·ªõi cƒÉn b·∫≠c 2 c·ªßa 252 n·∫øu mu·ªën "nƒÉm h√≥a" (annualize)
# # nh∆∞ng ƒë·ªÉ so s√°nh th√¨ kh√¥ng c·∫ßn)

# # 2. V·∫Ω b·∫±ng Plotly
# fig_rolling_vol = px.line(rolling_vol,
#                           x='Date',
#                           y='RollingVolatility',
#                           color='Ticker',
#                           # title='Bi·∫øn ƒë·ªông Tr∆∞·ª£t (30 ng√†y) - Th∆∞·ªõc ƒëo R·ªßi ro theo Th·ªùi gian'
#                           )
# fig_rolling_vol.update_layout(yaxis_title='ƒê·ªô l·ªách chu·∫©n (R·ªßi ro)',
#                             xaxis_title='Ng√†y',
#                             legend_title='M√£ C·ªï phi·∫øu')
# fig_rolling_vol.show()

# filename1234a = f"RollingVolatility20.png"
# fig_rolling_vol.write_image(filename1234a)
# files.download(filename1234a)

# print("--- Ho√†n th√†nh Bi·ªÉu ƒë·ªì Bi·∫øn ƒë·ªông Tr∆∞·ª£t ---")

print("--- 4. B·∫Øt ƒë·∫ßu v·∫Ω Bi·ªÉu ƒë·ªì Bi·∫øn ƒë·ªông Tr∆∞·ª£t ---")

# 1. T√≠nh to√°n ƒë·ªô l·ªách chu·∫©n tr∆∞·ª£t (v√≠ d·ª• c·ª≠a s·ªï 20 ng√†y)
rolling_vol = (
    combined_df.groupby('Ticker')['LogReturn']
    .rolling(window=60)   # C·ª≠a s·ªï tr∆∞·ª£t 20 ng√†y
    .std()                # T√≠nh ƒë·ªô l·ªách chu·∫©n
    .reset_index()
    .rename(columns={'LogReturn':'RollingVolatility'})
)

# 2. V·∫Ω b·∫±ng Plotly
fig_rolling_vol = px.line(
    rolling_vol,
    x='Date',
    y='RollingVolatility',
    color='Ticker',
    # color_discrete_sequence=px.colors.qualitative.Set2  # Gi·ªØ m√†u ƒë·ªìng b·ªô
    color_discrete_map=color_map
)

# 3. T√πy ch·ªânh layout
fig_rolling_vol.update_layout(
    plot_bgcolor='white',
    paper_bgcolor='white',
    yaxis_title='ƒê·ªô l·ªách chu·∫©n',
    xaxis_title='Ng√†y',
    legend_title='M√£ C·ªï phi·∫øu',
    font=dict(size=13),
    margin=dict(l=60, r=30, t=40, b=50)
)

# 4. ƒê·ªãnh d·∫°ng tr·ª•c
fig_rolling_vol.update_xaxes(
    tickformat="%Y-%m",  # hi·ªÉn th·ªã theo d·∫°ng 2024-04
    showgrid=True, gridwidth=0.5, gridcolor="LightGray"
)
fig_rolling_vol.update_yaxes(
    tickformat=".2f",    # hi·ªÉn th·ªã 0.0123 thay v√¨ 0.0123456
    showgrid=True, gridwidth=0.5, gridcolor="LightGray"
)

fig_rolling_vol.show()

filename1234a = "RollingVolatility60.png"
fig_rolling_vol.write_image(filename1234a)
files.download(filename1234a)

print("--- Ho√†n th√†nh Bi·ªÉu ƒë·ªì Bi·∫øn ƒë·ªông Tr∆∞·ª£t ---")

# print("--- 4. B·∫Øt ƒë·∫ßu v·∫Ω Bi·ªÉu ƒë·ªì Bi·∫øn ƒë·ªông Tr∆∞·ª£t ---")

# # 1. T√≠nh to√°n ƒë·ªô l·ªách chu·∫©n tr∆∞·ª£t (v√≠ d·ª• c·ª≠a s·ªï 30 ng√†y)
# # D√πng groupby('Ticker') ƒë·ªÉ t√≠nh rolling cho t·ª´ng m√£
# rolling_vol = (
#     combined_df.groupby('Ticker')['LogReturn']
#     .rolling(window=60)   # C·ª≠a s·ªï tr∆∞·ª£t 30 ng√†y
#     .std()                # T√≠nh ƒë·ªô l·ªách chu·∫©n
#     .reset_index()
#     .rename(columns={'LogReturn':'RollingVolatility'})
# )
# # (Ch√∫ng ta c·∫ßn nh√¢n v·ªõi cƒÉn b·∫≠c 2 c·ªßa 252 n·∫øu mu·ªën "nƒÉm h√≥a" (annualize)
# # nh∆∞ng ƒë·ªÉ so s√°nh th√¨ kh√¥ng c·∫ßn)

# # 2. V·∫Ω b·∫±ng Plotly
# fig_rolling_vol = px.line(rolling_vol,
#                           x='Date',
#                           y='RollingVolatility',
#                           color='Ticker',
#                           # title='Bi·∫øn ƒë·ªông Tr∆∞·ª£t (30 ng√†y) - Th∆∞·ªõc ƒëo R·ªßi ro theo Th·ªùi gian'
#                           )
# fig_rolling_vol.update_layout(yaxis_title='ƒê·ªô l·ªách chu·∫©n (R·ªßi ro)',
#                             xaxis_title='Ng√†y',
#                             legend_title='M√£ C·ªï phi·∫øu')
# fig_rolling_vol.show()

# filename1234ab = f"RollingVolatility60.png"
# fig_rolling_vol.write_image(filename1234ab)
# files.download(filename1234ab)

# print("--- Ho√†n th√†nh Bi·ªÉu ƒë·ªì Bi·∫øn ƒë·ªông Tr∆∞·ª£t ---")

"""M·ª•c ƒë√≠ch: Xem x√©t s·ª± thay ƒë·ªïi c·ªßa r·ªßi ro (bi·∫øn ƒë·ªông) theo th·ªùi gian.

√ù nghƒ©a: Gi√∫p b·∫°n x√°c ƒë·ªãnh c√°c "ch·∫ø ƒë·ªô th·ªã tr∆∞·ªùng" (market regimes).

Khi ƒë∆∞·ªùng bi·ªÉu ƒë·ªì ƒëi l√™n: Giai ƒëo·∫°n th·ªã tr∆∞·ªùng "b√£o t·ªë", r·ªßi ro cao.

Khi ƒë∆∞·ªùng bi·ªÉu ƒë·ªì ƒëi xu·ªëng: Giai ƒëo·∫°n th·ªã tr∆∞·ªùng "y√™n ·∫Øng", r·ªßi ro th·∫•p.
"""

# C√†i ƒë·∫∑t c√°c h·∫±ng s·ªë cho ph√¢n t√≠ch
TRADING_DAYS = 252  # S·ªë ng√†y giao d·ªãch trong 1 nƒÉm
RISK_FREE_RATE_ANNUAL = 0.03 # Gi·∫£ ƒë·ªãnh l√£i su·∫•t phi r·ªßi ro l√† 3%/nƒÉm

print("--- 1. B·∫£ng t√≥m t·∫Øt s·ªë li·ªáu ch√≠nh (Summary Statistics) ---")

summary_data = []

# L·∫∑p qua t·ª´ng m√£ trong dictionary
for ticker, df in stock_data.items():

    # 1. L·ª£i nhu·∫≠n trung b√¨nh ng√†y
    mean_daily_return = df['LogReturn'].mean()

    # 2. L·ª£i nhu·∫≠n nƒÉm h√≥a
    # (S·ª≠ d·ª•ng np.exp v√¨ ch√∫ng ta d√πng LogReturn)
    annualized_return = np.exp(mean_daily_return * TRADING_DAYS) - 1

    # 3. Bi·∫øn ƒë·ªông (r·ªßi ro) nƒÉm h√≥a
    annualized_volatility = df['LogReturn'].std() * np.sqrt(TRADING_DAYS)

    # 4. T·ª∑ l·ªá Sharpe
    # (L·ª£i nhu·∫≠n nƒÉm h√≥a - L√£i su·∫•t phi r·ªßi ro) / R·ªßi ro nƒÉm h√≥a
    sharpe_ratio = (annualized_return - RISK_FREE_RATE_ANNUAL) / annualized_volatility

    # 5. M·ª©c s·ª•t gi·∫£m t·ªëi ƒëa (Max Drawdown)
    cum_return_gross = (1 + df['Return']).cumprod() # D√πng Return (kh√¥ng ph·∫£i Log)
    running_max = cum_return_gross.cummax()
    drawdown = (cum_return_gross - running_max) / running_max
    max_drawdown = drawdown.min()

    # 6. Kh·ªëi l∆∞·ª£ng trung b√¨nh
    average_volume = df['Volume'].mean()

    # Th√™m v√†o danh s√°ch
    summary_data.append({
        'Ticker': ticker,
        'Mean Daily Return (%)': mean_daily_return * 100,
        'Annualized Return (%)': annualized_return * 100,
        'Annualized Volatility (%)': annualized_volatility * 100,
        'Sharpe Ratio': sharpe_ratio,
        'Max Drawdown (%)': max_drawdown * 100,
        'Average Volume': average_volume
    })

# T·∫°o DataFrame t·ª´ danh s√°ch
summary_df = pd.DataFrame(summary_data).set_index('Ticker')

# In b·∫£ng k·∫øt qu·∫£
# (S·ª≠ d·ª•ng .T ƒë·ªÉ chuy·ªÉn v·ªã cho d·ªÖ nh√¨n)
print(summary_df.round(2).T)

"""1. B·∫£ng t√≥m t·∫Øt s·ªë li·ªáu ch√≠nh (Summary Statistics)"""

print("\n--- 5. Ph√¢n t√≠ch ƒê·ªôt bi·∫øn Kh·ªëi l∆∞·ª£ng (Volume Spike) ---")

df_spike = combined_df.copy().reset_index()

# 1. T√≠nh to√°n Volume trung b√¨nh tr∆∞·ª£t
df_spike['Volume_MA20'] = (
    df_spike.groupby('Ticker')['Volume']
    .transform(lambda x: x.rolling(window=20).mean())
)

# 2. ƒê·ªãnh nghƒ©a ng√†y "Spike"
df_spike['Is_Spike_Day'] = df_spike['Volume'] > (2.5 * df_spike['Volume_MA20'])

# 3. V·∫Ω Scatter Plot (cho 1 m√£, v√≠ d·ª• HVN)
ticker_to_plot = 'HVN'
df_spike_single = df_spike[df_spike['Ticker'] == ticker_to_plot]

fig_scatter = px.scatter(df_spike_single,
                         x='Volume',
                         y='Return', # D√πng 'Return' (kh√¥ng ph·∫£i LogReturn)
                         color='Is_Spike_Day', # T√¥ m√†u theo ng√†y Spike
                        #  title=f'L·ª£i nhu·∫≠n vs Kh·ªëi l∆∞·ª£ng ({ticker_to_plot})'
                         )
fig_scatter.show()

filename1234ab5 = f"Is_Spike_Day.png"
fig_scatter.write_image(filename1234ab5)
files.download(filename1234ab5)

# 4. T·∫°o B·∫£ng t√≥m t·∫Øt so s√°nh
# So s√°nh |L·ª£i nhu·∫≠n| (bi·∫øn ƒë·ªông) v√†o ng√†y Spike v√† ng√†y th∆∞·ªùng
df_spike['Abs_Return'] = df_spike['Return'].abs()

spike_summary = (
    df_spike.groupby('Is_Spike_Day')['Abs_Return']
    .mean()
    .to_frame(name='Mean Absolute Return')
)

print("\n--- B·∫£ng t√≥m t·∫Øt Volume Spike ---")
print(spike_summary)

"""Ph√¢n t√≠ch ƒê·ªôt bi·∫øn Kh·ªëi l∆∞·ª£ng (Volume Spike)

Ch√∫ng ta s·∫Ω ƒë·ªãnh nghƒ©a "spike" l√† m·ªôt ng√†y c√≥ kh·ªëi l∆∞·ª£ng cao h∆°n 2 l·∫ßn so v·ªõi trung b√¨nh 20 ng√†y.
"""

import matplotlib.pyplot as plt
import seaborn as sns
import pandas as pd
import numpy as np

print("--- 3. B·∫Øt ƒë·∫ßu v·∫Ω Heatmap t∆∞∆°ng quan v√† ƒë·ªìng bi·∫øn ƒë·ªông ---")

# Reset index n·∫øu Date ƒëang l√† index
if 'Date' not in combined_df.columns:
    combined_df = combined_df.reset_index()

# Pivot l·∫°i: m·ªói c·ªôt l√† 1 m√£, m·ªói d√≤ng l√† 1 ng√†y
returns_pivot = combined_df.pivot(index='Date', columns='Ticker', values='LogReturn')

# --- 3.1. Heatmap t∆∞∆°ng quan (Full sample) ---
plt.figure(figsize=(8, 6))
corr_matrix = returns_pivot.corr()
sns.heatmap(corr_matrix, annot=True, cmap='coolwarm', center=0)
# plt.title('Heatmap T∆∞∆°ng quan L·ª£i su·∫•t (Full Sample)')
plt.xlabel("")  # X√≥a ch·ªØ ‚ÄúTicker‚Äù
plt.ylabel("")  # X√≥a ch·ªØ ‚ÄúTicker‚Äù

output_path = "HeatmapLoiSuat.png"
plt.savefig(output_path, bbox_inches='tight', dpi=300)
plt.show()

files.download(output_path)


# --- 3.2. Heatmap ƒë·ªìng bi·∫øn ƒë·ªông (Full sample) ---
plt.figure(figsize=(8, 6))
cov_matrix = returns_pivot.cov()
sns.heatmap(cov_matrix, annot=True, cmap='viridis')
# plt.title('Heatmap ƒê·ªìng bi·∫øn ƒë·ªông (Full Sample)')
plt.xlabel("")  # X√≥a ch·ªØ ‚ÄúTicker‚Äù
plt.ylabel("")  # X√≥a ch·ªØ ‚ÄúTicker‚Äù

output_path = "HeatmapDongBienDong.png"
plt.savefig(output_path, bbox_inches='tight', dpi=300)
plt.show()

files.download(output_path)
# --- 3.3. Heatmap t∆∞∆°ng quan Rolling Window ---
window_size = 30  # s·ªë ng√†y c·ª≠a s·ªï tr∆∞·ª£t
rolling_corr = returns_pivot.rolling(window=window_size).corr()

# Ki·ªÉm tra xem c√≥ c·∫∑p HVN, VJC kh√¥ng
tickers = returns_pivot.columns.tolist()
print("C√°c m√£ trong d·ªØ li·ªáu:", tickers)

if 'HVN' in tickers and 'VJC' in tickers:
    # L·∫•y t∆∞∆°ng quan rolling gi·ªØa HVN v√† VJC
    hvn_vjc_corr = rolling_corr.xs('HVN', level=1, axis=0)[['VJC']].dropna()

    plt.figure(figsize=(10, 5))
    plt.plot(hvn_vjc_corr.index, hvn_vjc_corr['VJC'], label='HVN - VJC', color='blue')
    plt.title(f'Rolling Correlation ({window_size} ng√†y) gi·ªØa HVN v√† VJC')
    plt.xlabel('Ng√†y')
    plt.ylabel('H·ªá s·ªë t∆∞∆°ng quan')
    plt.legend()
    plt.show()
else:
    print("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y c·∫∑p m√£ HVN v√† VJC trong d·ªØ li·ªáu!")

print("--- Ho√†n th√†nh Heatmap t∆∞∆°ng quan v√† ƒë·ªìng bi·∫øn ƒë·ªông ---")

print("--- 4. Ph√¢n t√≠ch Volume Spike vs Return ---")

import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
import pandas as pd

# ƒê·∫£m b·∫£o c√≥ c·ªôt Date
if 'Date' not in combined_df.columns:
    combined_df = combined_df.reset_index()

# X√°c ƒë·ªãnh Volume trung b√¨nh v√† ƒë·ªô l·ªách chu·∫©n theo t·ª´ng m√£ c·ªï phi·∫øu
volume_stats = combined_df.groupby('Ticker')['Volume'].agg(['mean', 'std']).reset_index()

# G·ªôp th·ªëng k√™ v√†o d·ªØ li·ªáu g·ªëc
combined_df = combined_df.merge(volume_stats, on='Ticker', how='left', suffixes=('', '_stats'))

# ƒê√°nh d·∫•u ng√†y c√≥ "Volume Spike": Volume > mean + 2*std
combined_df['IsSpike'] = combined_df['Volume'] > (combined_df['mean'] + 2 * combined_df['std'])

# --- 4.1. Scatter Plot: Volume vs Return ---
plt.figure(figsize=(10, 6))
sns.scatterplot(
    data=combined_df,
    x='Volume',
    y='Return',
    hue='IsSpike',
    alpha=0.7,
    palette={True: 'red', False: 'blue'}
)
# plt.title('Ph√¢n t√≠ch Volume Spike vs Return')
plt.xlabel('Kh·ªëi l∆∞·ª£ng giao d·ªãch (Volume)')
plt.ylabel('L·ª£i nhu·∫≠n (%)')
plt.legend(title='Volume Spike')

output_path = "VolumeSpikeVsReturn.png"
plt.savefig(output_path, bbox_inches='tight', dpi=300)
plt.show()

files.download(output_path)

# --- 4.2. Summary Table: Mean |Return| tr√™n Spike v√† Non-Spike ---
summary = (
    combined_df.groupby(['Ticker', 'IsSpike'])['Return']
    .apply(lambda x: np.mean(np.abs(x)))
    .reset_index()
    .pivot(index='Ticker', columns='IsSpike', values='Return')
)

summary.columns = ['Mean |Return| (Non-Spike)', 'Mean |Return| (Spike)']
summary['Spike/NonSpike Ratio'] = summary['Mean |Return| (Spike)'] / summary['Mean |Return| (Non-Spike)']
summary = summary.round(4)

print("\n--- Summary Table: So s√°nh ƒë·ªô bi·∫øn ƒë·ªông gi·ªØa ng√†y Spike v√† Non-Spike ---")
print(summary)

# --- 4.3. Bar chart minh h·ªça k·∫øt qu·∫£ ---
summary_plot = summary[['Mean |Return| (Non-Spike)', 'Mean |Return| (Spike)']].reset_index()
summary_plot.plot(
    x='Ticker',
    kind='bar',
    figsize=(9, 5),
    # title='So s√°nh |Return| trung b√¨nh: Spike vs Non-Spike',
    xlabel='M√£ c·ªï phi·∫øu',
    ylabel='Gi√° tr·ªã trung b√¨nh tuy·ªát ƒë·ªëi c·ªßa Return',
)
plt.xticks(rotation=0)
plt.tight_layout()

output_path = "SpikeVsNon-Spike.png"
plt.savefig(output_path, bbox_inches='tight', dpi=300)
plt.show()

files.download(output_path)

print("--- Ho√†n th√†nh Ph√¢n t√≠ch Volume Spike vs Return ---")